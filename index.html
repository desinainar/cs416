<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID-19: The Story in Data</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #dc3545;
            padding-bottom: 20px;
        }
        
        .header h1 {
            color: #dc3545;
            font-size: 2.5em;
            margin: 0;
        }
        
        .header p {
            color: #666;
            font-size: 1.2em;
            margin: 10px 0 0 0;
        }
        
        .navigation {
            text-align: center;
            margin: 20px 0;
        }
        
        .nav-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 25px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .nav-button:hover {
            background: #c82333;
        }
        
        .nav-button.active {
            background: #28a745;
        }
        
        .nav-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .scene-container {
            min-height: 600px;
            position: relative;
        }
        
        .scene-title {
            font-size: 1.8em;
            color: #dc3545;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .scene-description {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 25px;
            text-align: center;
            line-height: 1.5;
        }
        
        .annotation {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 250px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .annotation::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }
        
        .annotation.top::before {
            bottom: -10px;
            left: 20px;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #dc3545;
        }
        
        .annotation.bottom::before {
            top: -10px;
            left: 20px;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid #dc3545;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 15px 10px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 3px;
        }
        
        .state-selector {
            margin: 20px 0;
            text-align: center;
        }
        
        .state-selector select {
            padding: 8px 15px;
            font-size: 16px;
            border: 2px solid #dc3545;
            border-radius: 5px;
            background: white;
        }
        
        .loading {
            text-align: center;
            font-size: 1.2em;
            color: #666;
            margin: 50px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>COVID-19: The Story in Data</h1>
            <p>A narrative visualization of the pandemic's impact across the United States</p>
        </div>
        
        <div class="navigation">
            <button class="nav-button active" onclick="showScene(1)">National Overview</button>
            <button class="nav-button" onclick="showScene(2)">State Comparison</button>
            <button class="nav-button" onclick="showScene(3)">Timeline Deep Dive</button>
        </div>
        
        <div class="scene-container" id="scene-container">
            <div class="loading">Loading COVID-19 data...</div>
        </div>
        
        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        // Global parameters (state variables)
        let currentScene = 1;
        let covidData = [];
        let stateData = [];
        let selectedStates = ['California', 'Texas', 'Florida', 'New York', 'Pennsylvania'];
        let selectedDateRange = { start: new Date('2020-03-01'), end: new Date('2023-12-31') };
        
        // Color schemes
        const colors = {
            cases: '#ff6b6b',
            deaths: '#4ecdc4',
            primary: '#dc3545',
            secondary: '#28a745',
            background: '#f8f9fa'
        };
        
        // Dimensions
        const margin = { top: 40, right: 60, bottom: 60, left: 80 };
        const width = 900 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;
        
        // Load and process data
        async function loadData() {
            try {
                // Load US states data from NY Times COVID dataset
                const response = await fetch('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv');
                const csvText = await response.text();
                
                // Parse CSV
                const data = d3.csvParse(csvText, d => ({
                    date: d3.timeParse('%Y-%m-%d')(d.date),
                    state: d.state,
                    cases: +d.cases,
                    deaths: +d.deaths
                }));
                
                covidData = data.filter(d => d.date && d.cases >= 0 && d.deaths >= 0);
                
                // Process state-level data
                stateData = d3.group(covidData, d => d.state);
                
                // Show initial scene
                showScene(1);
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('scene-container').innerHTML = `
                    <div class="loading" style="color: #dc3545;">
                        Error loading data. Using sample data for demonstration.
                    </div>
                `;
                
                // Generate sample data for demonstration
                generateSampleData();
                showScene(1);
            }
        }
        
        // Generate sample data if real data fails to load
        function generateSampleData() {
            const states = ['California', 'Texas', 'Florida', 'New York', 'Pennsylvania', 'Illinois', 'Ohio', 'Georgia', 'North Carolina', 'Michigan'];
            const startDate = new Date('2020-03-01');
            const endDate = new Date('2023-12-31');
            
            covidData = [];
            
            states.forEach(state => {
                let cases = 0;
                let deaths = 0;
                
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 7)) {
                    const growthRate = Math.random() * 0.1 + 0.02;
                    cases += Math.floor(cases * growthRate + Math.random() * 1000 + 100);
                    deaths += Math.floor(deaths * growthRate + Math.random() * 20 + 1);
                    
                    covidData.push({
                        date: new Date(d),
                        state: state,
                        cases: cases,
                        deaths: deaths
                    });
                }
            });
            
            stateData = d3.group(covidData, d => d.state);
        }
        
        // Scene 1: National Overview
        function renderScene1() {
            const container = d3.select('#scene-container');
            container.html('');
            
            // Scene content
            container.append('div')
                .attr('class', 'scene-title')
                .text('National COVID-19 Trends');
            
            container.append('div')
                .attr('class', 'scene-description')
                .text('Overview of cumulative cases and deaths across all US states since March 2020');
            
            // Create SVG
            const svg = container.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .style('display', 'block')
                .style('margin', '0 auto');
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Aggregate national data
            const nationalData = d3.rollup(covidData, 
                v => ({
                    cases: d3.sum(v, d => d.cases),
                    deaths: d3.sum(v, d => d.deaths)
                }), 
                d => d3.timeFormat('%Y-%m-%d')(d.date)
            );
            
            const aggregatedData = Array.from(nationalData, ([date, values]) => ({
                date: d3.timeParse('%Y-%m-%d')(date),
                cases: values.cases,
                deaths: values.deaths
            })).sort((a, b) => a.date - b.date);
            
            // Scales
            const xScale = d3.scaleTime()
                .domain(d3.extent(aggregatedData, d => d.date))
                .range([0, width]);
            
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(aggregatedData, d => d.cases)])
                .range([height, 0]);
            
            const yScale2 = d3.scaleLinear()
                .domain([0, d3.max(aggregatedData, d => d.deaths)])
                .range([height, 0]);
            
            // Line generators
            const casesLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.cases))
                .curve(d3.curveMonotoneX);
            
            const deathsLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale2(d.deaths))
                .curve(d3.curveMonotoneX);
            
            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat('%b %Y')));
            
            g.append('g')
                .call(d3.axisLeft(yScale).tickFormat(d3.format('.2s')));
            
            g.append('g')
                .attr('transform', `translate(${width},0)`)
                .call(d3.axisRight(yScale2).tickFormat(d3.format('.2s')));
            
            // Add lines
            g.append('path')
                .datum(aggregatedData)
                .attr('fill', 'none')
                .attr('stroke', colors.cases)
                .attr('stroke-width', 3)
                .attr('d', casesLine);
            
            g.append('path')
                .datum(aggregatedData)
                .attr('fill', 'none')
                .attr('stroke', colors.deaths)
                .attr('stroke-width', 3)
                .attr('d', deathsLine);
            
            // Add labels
            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .text('Total Cases');
            
            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', width + margin.right + 8)
                .attr('x', 0 - (height / 2))
                .attr('dy', '-1em')
                .style('text-anchor', 'middle')
                .text('Total Deaths');
            
            const annotationButton = g.append('circle')
                .attr('cx', 465)
                .attr('cy', 190)
                .attr('r', 12)
                .attr('fill', colors.primary)
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .style('cursor', 'pointer')
                .on('click', function() {
                    const annotation = d3.select('.scene1-annotation');
                    const isVisible = annotation.style('display') !== 'none';
                    annotation.style('display', isVisible ? 'none' : 'block');
                });

            // Add "i" icon to button
            g.append('text')
                .attr('x', 465)
                .attr('y', 195)
                .attr('text-anchor', 'middle')
                .attr('fill', 'white')
                .attr('font-size', '14px')
                .attr('font-weight', 'bold')
                .text('i')
                .style('pointer-events', 'none');

            // Add annotation (initially hidden)
            const annotation = container.append('div')
                .attr('class', 'annotation top scene1-annotation')
                .style('left', '675px')
                .style('top', '175px')
                .style('display', 'none')  // Initially hidden
                .html('The exponential growth phase occurred primarily in <strong>2021-2022</strong>, with multiple waves visible in the data.');
            
                    
            // Add legend
            const legend = container.append('div')
                .attr('class', 'legend');
            
            legend.append('div')
                .attr('class', 'legend-item')
                .html(`<div class="legend-color" style="background-color: ${colors.cases}"></div><span>Total Cases</span>`);
            
            legend.append('div')
                .attr('class', 'legend-item')
                .html(`<div class="legend-color" style="background-color: ${colors.deaths}"></div><span>Total Deaths</span>`);
        }
        
        // Scene 2: State Comparison
        function renderScene2() {
            const container = d3.select('#scene-container');
            container.html('');
            
            container.append('div')
                .attr('class', 'scene-title')
                .text('State-by-State Comparison');
            
            container.append('div')
                .attr('class', 'scene-description')
                .text('Interactive comparison of COVID-19 impact across the most affected states');
            
            // State selector
            const selector = container.append('div')
                .attr('class', 'state-selector');
            
            selector.append('label')
                .text('Highlight State: ');
            
            const select = selector.append('select')
                .on('change', function() {
                    updateStateHighlight(this.value);
                });
            
            select.selectAll('option')
                .data(['All States'].concat(selectedStates))
                .enter()
                .append('option')
                .attr('value', d => d)
                .text(d => d);
            
            // Create SVG
            const svg = container.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .style('display', 'block')
                .style('margin', '0 auto');
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Get latest data for each state
            const latestData = selectedStates.map(state => {
                const stateEntries = stateData.get(state) || [];
                const latest = stateEntries[stateEntries.length - 1] || { cases: 0, deaths: 0 };
                return {
                    state: state,
                    cases: latest.cases,
                    deaths: latest.deaths,
                    casesPerCapita: latest.cases / 1000000 // Simplified per capita calculation
                };
            }).sort((a, b) => b.cases - a.cases);
            
            // Scales
            const xScale = d3.scaleBand()
                .domain(latestData.map(d => d.state))
                .range([0, width])
                .padding(0.1);
            
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(latestData, d => d.cases)])
                .range([height, 0]);
            
            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');
            
            g.append('g')
                .call(d3.axisLeft(yScale).tickFormat(d3.format('.2s')));
            
            // Add bars
            const bars = g.selectAll('.bar')
                .data(latestData)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', d => xScale(d.state))
                .attr('width', xScale.bandwidth())
                .attr('y', d => yScale(d.cases))
                .attr('height', d => height - yScale(d.cases))
                .attr('fill', colors.cases)
                .attr('opacity', 0.8)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('opacity', 1);
                    showTooltip(event, `${d.state}<br/>Cases: ${d3.format(',')(d.cases)}<br/>Deaths: ${d3.format(',')(d.deaths)}`);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('opacity', 0.8);
                    hideTooltip();
                });
            
            
            // Store reference for highlighting
            container.property('bars', bars);
        }
        
        // Scene 3: Timeline Deep Dive
        function renderScene3() {
            const container = d3.select('#scene-container');
            container.html('');
            
            container.append('div')
                .attr('class', 'scene-title')
                .text('Timeline Deep Dive');
            
            container.append('div')
                .attr('class', 'scene-description')
                .text('Key periods and milestones in the COVID-19 timeline with detailed annotations');
            
            // Create SVG
            const svg = container.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .style('display', 'block')
                .style('margin', '0 auto');
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Use California data as example
            const californiaData = stateData.get('California') || [];
            const timelineData = californiaData.map(d => ({
                date: d.date,
                newCases: d.cases,
                newDeaths: d.deaths
            }));
            
            // Calculate daily new cases (simplified)
            for (let i = 1; i < timelineData.length; i++) {
                timelineData[i].dailyCases = Math.max(0, timelineData[i].newCases - timelineData[i-1].newCases);
            }
            
            // Scales
            const xScale = d3.scaleTime()
                .domain(d3.extent(timelineData, d => d.date))
                .range([0, width]);
            
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(timelineData, d => d.dailyCases || 0)])
                .range([height, 0]);
            
            // Area generator
            const area = d3.area()
                .x(d => xScale(d.date))
                .y0(height)
                .y1(d => yScale(d.dailyCases || 0))
                .curve(d3.curveMonotoneX);
            
            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat('%b %Y')));
            
            g.append('g')
                .call(d3.axisLeft(yScale).tickFormat(d3.format('.2s')));
            
            // Add area chart
            g.append('path')
                .datum(timelineData)
                .attr('fill', colors.cases)
                .attr('opacity', 0.6)
                .attr('d', area);
            
            // Key events (sample dates)
            const keyEvents = [
                { date: new Date('2020-03-15'), label: 'Initial Lockdowns', y: 120 },
                { date: new Date('2020-08-01'), label: 'Second Wave', y: 220 },
                { date: new Date('2021-01-01'), label: 'Winter Surge', y: 300 },
                { date: new Date('2021-12-01'), label: 'Omicron Variant', y: 125 }
            ];
            
            // Add event markers
            keyEvents.forEach((event, i) => {
                g.append('line')
                    .attr('x1', xScale(event.date))
                    .attr('x2', xScale(event.date))
                    .attr('y1', 0)
                    .attr('y2', height)
                    .attr('stroke', colors.primary)
                    .attr('stroke-dasharray', '5,5')
                    .attr('opacity', 0.7);
                
                // Add event annotation
                const annotation = container.append('div')
                    .attr('class', 'annotation top')
                    .style('left', `${xScale(event.date) + margin.left + 118}px`)
                    .style('top', `${event.y}px`)
                    .html(`<strong>${event.label}</strong><br/>Key milestone in pandemic timeline`);
            });
            
            // Add y-axis label
            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .text('Daily New Cases (California)');
        }
        
        // Utility functions
        function showScene(sceneNumber) {
            currentScene = sceneNumber;
            
            // Update navigation buttons
            d3.selectAll('.nav-button')
                .classed('active', false);
            
            d3.select(`.nav-button:nth-child(${sceneNumber})`)
                .classed('active', true);
            
            // Render appropriate scene
            switch(sceneNumber) {
                case 1:
                    renderScene1();
                    break;
                case 2:
                    renderScene2();
                    break;
                case 3:
                    renderScene3();
                    break;
            }
        }
        
        function updateStateHighlight(selectedState) {
            if (currentScene !== 2) return;
            
            const container = d3.select('#scene-container');
            const bars = container.property('bars');
            
            if (bars) {
                bars.attr('opacity', d => 
                    selectedState === 'All States' || d.state === selectedState ? 1 : 0.3
                );
            }
        }
        
        function showTooltip(event, content) {
            const tooltip = d3.select('#tooltip');
            tooltip.html(content)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px')
                .style('opacity', 1);
        }
        
        function hideTooltip() {
            d3.select('#tooltip').style('opacity', 0);
        }
        
        // Initialize the visualization
        loadData();
    </script>
</body>
</html>